version: "3.7"
services:
  loadbalancer:
    image: httpd:2.4.54-bullseye
    ports:
      - "8080:80"
    volumes:
      - ./loadbalancer/httpd.conf:/usr/local/apache2/conf/httpd.conf
    depends_on:
      - "app"

  app:
    build: frontend/
    deploy:
      mode: replicated
      replicas: 2

  backend:
    build: backend/
    restart: on-failure
    ports:
      - "6868:8080"
    depends_on:
      - "db"
    env_file: ./.env
    environment:
      - POSTGRES_USER=$POSTGRES_USER
      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      - POSTGRES_DATABASE=$POSTGRES_DATABASE

  db:
    image: postgres:15.0-bullseye
    restart: unless-stopped
    ports:
      - "5454:5432"
    env_file: ./.env
    environment:
      - POSTGRES_USER=$POSTGRES_USER
      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      - POSTGRES_DATABASE=$POSTGRES_DATABASE
    volumes:
      - ./db/:/docker-entrypoint-initdb.d/
